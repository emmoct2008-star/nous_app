<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nous App - Profils & Surprises</title>
<style>
body { font-family:'Arial',sans-serif; background:#fff0f6; margin:0; color:#4d3b4d; }
h1,h2 { text-align:center; margin:12px 0; color:#7d4b7d; }
.container { max-width:420px; margin:0 auto; padding:12px; }
button { margin-top:10px; padding:12px 15px; border:none; border-radius:12px; background:linear-gradient(120deg,#ffb6c1,#ffc0cb); color:white; cursor:pointer; width:100%; font-size:16px; transition:0.2s; }
button:hover { background:linear-gradient(120deg,#ff8da1,#ffb6c1); }
.day { width:50px; height:50px; display:inline-block; margin:4px; text-align:center; vertical-align:top; border-radius:8px; background:#ffe6f0; line-height:50px; cursor:pointer; transition:0.2s; font-weight:bold; position:relative; }
.day.received { background:#b78ac7; color:white; }
#modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; }
#modalContent { background:white; padding:15px; border-radius:12px; max-width:90%; max-height:80%; overflow:auto; }
input,textarea,select { width:100%; margin-top:6px; padding:6px; border-radius:12px; border:1px solid #d4a5c0; resize:vertical; }
textarea { min-height:40px; background:#fff0f6; }
#counterDisplay { font-size:22px; text-align:center; margin-top:12px; background:#ffe6f0; padding:12px; border-radius:12px; position:relative; }
a { color:#7d4b7d; text-decoration:underline; }
#monthSelector { margin-bottom:10px; }
.message-controls { margin-top:6px; text-align:right; }
.message-controls button { width:auto; margin-left:6px; padding:4px 6px; font-size:12px; }
</style>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<!-- Accueil -->
<div id="home" class="container">
<h1>üíñ Bienvenue sur Nous üíñ</h1>
<button onclick="openProfile('Moi')">Moi</button>
<button onclick="openProfile('Mon copain')">Mon copain</button>
<button onclick="showSection('counter')">üíñ Compteur amoureux</button>
</div>

<!-- Profil -->
<div id="profilePage" class="container" style="display:none">
<h2 id="profileName"></h2>
<button onclick="goHome()">‚Üê Retour √† l'accueil</button>
<hr>
<label>Mois :</label>
<select id="monthSelector"></select>
<div id="aventSection" style="margin-top:12px">
<div id="daysContainer" style="margin-top:12px;"></div>
</div>
</div>

<!-- Compteur amoureux -->
<div id="counter" class="container" style="display:none; text-align:center">
<button onclick="goHome()">‚Üê Retour √† l'accueil</button>
<label>Date de d√©but :</label>
<input type="date" id="startDate" onchange="saveCoupleDate(this.value); calculateTime();">
<div id="counterDisplay"></div>
</div>

<!-- Modal -->
<div id="modal" onclick="closeModal(event)">
<div id="modalContent">
<h3 id="modalTitle">Message</h3>
<div id="msgContent" style="min-height:40px; margin-bottom:12px;"></div>
<div id="msgInputArea">
<label>Message :</label>
<textarea id="msgText" placeholder="√âcris ton mot doux..."></textarea>
<label>Lien (facultatif) :</label>
<input type="text" id="msgLink" placeholder="YouTube, Insta...">
<label>Emoji ou mot doux (facultatif) :</label>
<input type="text" id="msgEmoji" placeholder="üíñ">
<p>Aper√ßu :</p>
<div id="msgPreview" style="border:1px solid #d4a5c0; padding:6px; border-radius:8px; min-height:40px; background:#fff0f6;"></div>
<button onclick="saveMessage()">Envoyer üíå</button>
</div>
<button onclick="modal.style.display='none'" style="margin-top:10px;">Fermer</button>
</div>
</div>

<script>
// ===== Firebase config =====
const firebaseConfig = {
  apiKey: "AIzaSyDfIxJ2yx21eFJ8o9sbBsr6mz19XI--9r4",
  authDomain: "nousapp-45128.firebaseapp.com",
  projectId: "nousapp-45128",
  storageBucket: "nousapp-45128.firebasestorage.app",
  messagingSenderId: "207095778988",
  appId: "1:207095778988:web:89e93c028f911ba2455909"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===== Variables =====
let profile='';
let selectedDay=null;
let currentMonth=new Date().getMonth();
let isEditing=false;
let editingDay=null;
const otherProfile={"Moi":"Mon copain","Mon copain":"Moi"};
const monthNames=["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"];

const home=document.getElementById('home');
const profilePage=document.getElementById('profilePage');
const profileNameEl=document.getElementById('profileName');
const daysContainer=document.getElementById('daysContainer');
const modal=document.getElementById('modal');
const msgText=document.getElementById('msgText');
const msgLink=document.getElementById('msgLink');
const msgEmoji=document.getElementById('msgEmoji');
const msgPreview=document.getElementById('msgPreview');
const msgContent=document.getElementById('msgContent');
const msgInputArea=document.getElementById('msgInputArea');
const monthSelectorEl=document.getElementById('monthSelector');
const counterDisplay=document.getElementById('counterDisplay');
const modalTitle=document.getElementById('modalTitle');

// ===== Initialisation mois =====
monthNames.forEach((m,i)=>{
  const option=document.createElement('option');
  option.value=i;
  option.textContent=m;
  monthSelectorEl.appendChild(option);
});
monthSelectorEl.value=currentMonth;
monthSelectorEl.addEventListener('change',()=>{
  currentMonth=parseInt(monthSelectorEl.value);
  loadMonthData();
});

// ===== Navigation =====
function goHome(){
  home.style.display='block';
  profilePage.style.display='none';
  document.getElementById('counter').style.display='none';
}
function showSection(section){
  home.style.display='none';
  profilePage.style.display='none';
  document.getElementById('counter').style.display=(section==='counter')?'block':'none';
}
function openProfile(p){
  profile=p;
  profileNameEl.textContent="Profil : "+profile;
  home.style.display='none';
  profilePage.style.display='block';
  loadMonthData();
}

// ===== Calendrier =====
function loadMonthData(){
  daysContainer.innerHTML='';
  const daysInMonth=new Date(new Date().getFullYear(), currentMonth+1, 0).getDate();
  db.ref('surprises/'+profile+'/'+currentMonth).on('value', snapshot=>{
    const data=snapshot.val() || {};
    for(let day=1; day<=daysInMonth; day++){
      const dayDiv=document.createElement('div');
      dayDiv.className='day';
      dayDiv.textContent=day;
      if(data[day]) dayDiv.classList.add('received');
      dayDiv.addEventListener('click',()=>{
        selectedDay=day;
        if(data[day]) showReceived(data[day].text);
        else showModal();
      });
      daysContainer.appendChild(dayDiv);
    }
  });
}

// ===== Modal =====
function closeModal(e){ if(e.target===modal) modal.style.display='none'; }
function updatePreview(){
  let text=(msgEmoji.value?msgEmoji.value+' ':'')+msgText.value;
  if(msgLink.value) text+=`<br><a href="${msgLink.value}" target="_blank">Lien</a>`;
  msgPreview.innerHTML=text;
}
function showModal(){
  msgText.value=''; msgLink.value=''; msgEmoji.value='';
  msgPreview.innerHTML=''; msgContent.innerHTML='';
  msgInputArea.style.display='block';
  modalTitle.textContent="Envoyer un message";
  modal.style.display='flex';
  isEditing=false;
  msgText.addEventListener('input',updatePreview);
  msgLink.addEventListener('input',updatePreview);
  msgEmoji.addEventListener('input',updatePreview);
}
function showReceived(content){
  msgContent.innerHTML=content;
  msgInputArea.style.display='none';
  modalTitle.textContent="Message re√ßu";

  const controls=document.createElement('div');
  controls.className='message-controls';
  const editBtn=document.createElement('button');
  editBtn.textContent='Modifier';
  editBtn.onclick=()=>{
    isEditing=true;
    msgInputArea.style.display='block';
    msgText.value=''; msgLink.value=''; msgEmoji.value='';
    msgPreview.innerHTML='';
    msgContent.innerHTML='';
    modalTitle.textContent="Modifier le message";
    modal.style.display='flex';
  };
  const delBtn=document.createElement('button');
  delBtn.textContent='Supprimer';
  delBtn.onclick=()=>{
    if(confirm('Supprimer ce message ?')){
      db.ref('surprises/'+profile+'/'+currentMonth+'/'+selectedDay).remove();
      modal.style.display='none';
    }
  };
  controls.appendChild(editBtn);
  controls.appendChild(delBtn);
  msgContent.appendChild(controls);
}

// ===== Envoi / mise √† jour message =====
function saveMessage(){
  if(!selectedDay) return;
  let text=(msgEmoji.value?msgEmoji.value+' ':'')+msgText.value;
  if(msgLink.value) text+=`<br><a href="${msgLink.value}" target="_blank">Lien</a>`;
  db.ref('surprises/'+otherProfile[profile]+'/'+currentMonth+'/'+selectedDay).set({ text: text });
  modal.style.display='none';
  loadMonthData();
}

// ===== Compteur amoureux =====
function calculateTime(){
  const start=new Date(document.getElementById('startDate').value);
  if(!start.getTime()){ counterDisplay.textContent=''; return; }
  const now=new Date();
  let years=now.getFullYear()-start.getFullYear();
  let months=now.getMonth()-start.getMonth();
  let days=now.getDate()-start.getDate();
  if(days<0){ months--; days+=new Date(now.getFullYear(), now.getMonth(),0).getDate(); }
  if(months<0){ years--; months+=12; }
  counterDisplay.innerHTML=`<span style="font-size:26px;">üíñ ${years} an(s), ${months} mois et ${days} jour(s) üíñ</span>`;
}
function saveCoupleDate(date){ db.ref('compteur/couple').set({ startDate: date }); }
function loadCoupleDate(){ db.ref('compteur/couple/startDate').once('value').then(snapshot=>{ const date=snapshot.val(); if(date) document.getElementById('startDate').value=date; calculateTime(); }); }

// ===== Initialisation =====
loadCoupleDate();
</script>
</body>
</html>
